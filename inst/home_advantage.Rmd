---
title: "Quantifying the home ground advantage with `hyper2` and `hyper3` objects"
author: "R. K. S. Hankin"
output: bookdown::html_document2
bibliography: hyper2.bib  # copy vignettes/hyper2.bib to inst/
---

```{r,label=libload,echo=FALSE,print=FALSE,warning=FALSE,include=FALSE}
defaultW <- getOption("warn") 
options(warn = -1) 
library("hyper2",quietly=TRUE)
library("magrittr")
options(warn = defaultW)
```

```{r out.width='20%', out.extra='style="float:right; padding:10px"',echo=FALSE}
knitr::include_graphics(system.file("help/figures/hyper2.png", package = "hyper2"))
```

<font size="1"> (takes about fifteen minutes to run without cache)
</font>


To cite the `hyper2` package in publications, please use
@hankin2017_rmd.  Here I analyse a small synthetic dataset for home
ground advantage, then go on to discuss a dataset presented by
Agresti.  At the end, I show how a results table can be created from
scratch using bespoke function `home_away_table()`.

But first, the smallest nontrivial example is a 2x2 case:

```{r,label=smallestexample}
M <- matrix(c(
    NA, 1+5i, 3+11i, NA),
    nrow=2,ncol=2,byrow=TRUE)

teams <- LETTERS[seq_len(2)]
dimnames(M) <- list("@home" = teams,"@away"=teams)
dimnames(M) <- list("@home" = teams,"@away"=teams)
M
home_away(M)
```

Above we see (from `M[1,2]`) that A played at home $1+5=6$ times,
winning 1 and losing 5; and B played at home $3+11=14$ times, winning
3 and losing 11.   A slightly more complicated example:

```{r,label=genthedata}
home_games_won <- matrix(c(
    NA, 16, 12, 11,
    19, NA, 19, 16,
    17, 12, NA, 11,
    11, 12, 12, NA),
    nrow=4,ncol=4,byrow=TRUE)

away_games_won <- matrix(c(
    NA, 05, 02, 02,
     9, NA, 10, 02,
     3, 04, NA, 07,
     8, 06, 04, NA),
    nrow=4,ncol=4,byrow=TRUE)

teams <- LETTERS[1:4]
dimnames(home_games_won) <- list("@home" = teams,"@away"=teams)
dimnames(away_games_won) <- list("@home" = teams,"@away"=teams)

home_games_won
away_games_won
```

Thus `home_games_won[1,2] == 16` means A played at home against B and
won 16 times; `home_games_won[2,1] == 19` means B played at home
against A and won 19 times.  Also, `away_games_won[1,2] == 5` means A
played away against B and won 5 times, and `away_games_won[2,1] == 2`
means B played away against A and won 2 times.  Alternatively, A
played B 16+19+5+2=45 times; A played at home 16+2=18 times and won 16
times and lost 2 times; and B played at home 19+5=24 times and won 19
times and lost 5 times.  Alternatively we may use complex numbers to
represent the same dataset:

```{r,label=showhomeawayusingcomplex}
home_games_won + 1i*away_games_won
```

We will create a hyper2 object with the teams and home ground advantage term:

```{r,label=makehyper2,cache=TRUE}
H <- home_away(home_games_won,away_games_won)
H
options("use_alabama" = FALSE) # to avoid the stupid wmmin bug
specificp.gt.test(H,"home",0)
options("use_alabama" = TRUE) # to avoid the stupid wmmin bug
```

We see strong evidence to support the contention that home advantage
is real.  Further, we may test the hypothesis that all the teams have
the same strength, after accounting for the home team advantage:

```{r,label=homegroundAgresti,cache=TRUE}
samep.test(H,teams)
```

Above, we see no evidence for a difference in team strengths.  Visually:

```{r,label=showvisH,cache=TRUE}
(mt <- maxp(H))
```

A profile likelihood diagram:

```{r,label=showprofilelikelihood, cache=TRUE}
home_strength <- seq(from=0.15,to=0.45,length=13)
plot(home_strength,profsupp(H,"home",home_strength),type="b",pch=16,
     xlab="home strength",ylab="support",main="profile likelihood for home advantage")
abline(h=c(0,-2))
```

The figure give a support interval between about 0.3 and 0.5 for home
ground advantage.


# Example in Agresti

Agresti considers a dataset of seven baseball teams who play one
another repeatedly.  Each game is played at the home ground of one
team, the other playing away.  The dataset is as follows:

```{r,label=makeAgrestimatrix}
baseball_table <- matrix(c(
NA,   4+3i, 4+2i, 4+3i, 6+1i, 4+2i, 6+0i,
3+3i, NA  , 4+2i, 4+3i, 6+0i, 6+1i, 4+3i,
2+5i, 4+3i, NA  , 2+4i, 4+3i, 4+2i, 6+0i,
3+3i, 5+1i, 2+5i, NA  , 4+3i, 4+2i, 6+1i,
5+1i, 2+5i, 3+3i, 4+2i, NA  , 5+2i, 6+0i,
2+5i, 3+3i, 3+4i, 4+3i, 4+2i, NA  , 2+4i,
2+5i, 1+5i, 1+6i, 2+4i, 1+6i, 3+4i, NA),7,7)
teams <- c("Milwaukee", "Detroit", "Toronto", "New York", "Boston","Cleveland","Baltimore")
rownames(baseball_table) <- teams
colnames(baseball_table) <- teams
M <- baseball_table # saves typing
```

Above, we represent home team wins with the real part of the matrix,
the imaginary component being away wins.  Now process it:

```{r,label=makesuppfrommatrix}
baseball <- home_away(M)
baseball
```

Maximum likelihood:

```{r,label=calculatemaxpAgresti,cache=TRUE}
baseball_maxp <- maxp(baseball)
baseball_maxp
```

Visually:

```{r,label=showmaxpAgresti}
dotchart(baseball_maxp,pch=16)
pie(baseball_maxp)
```

Above, we see that the teams are all of roughly equal strength, and
the home advantage is small.  However, we may easily assess the null
that the home strength is zero:

```{r,analyseAgresti,cache=TRUE}
specificp.gt.test(baseball,"home",0)
```

```{r,Agrestiprofsupp,cache=TRUE}
home_strength <- seq(from=0.005,to=0.1,length=20)
plot(home_strength,profsupp(baseball,"home",home_strength),type="b",pch=16,
     xlab="home strength",ylab="support",main="profile likelihood for home advantage")
abline(h=c(0,-2))
```

Further, we may test the hypothesis that the baseball teams have the same strength:

```{r,label=testhomegroundadvantage,cache=TRUE}
samep.test(baseball,teams)
```

Above, we see no evidence for the teams having differential strengths.

As an interesting aside, suppose we have some additional data from
games in which (for some reason), the home advantage was not
operating.  

```{r,label=newinfotobaseball}
M2 <- matrix(c(0,1,2,0),2,2)
dimnames(M2) <- list(winner=teams[1:2],loser=teams[1:2])
M2
```

Thus we have additional data from three games in which Milwaukee won
twice and lost once.  This additional information may easily be
incorporated into our likelihood function, at least on the assumption
of independence:

```{r,label=addsomenewinfotobaseball}
baseball <- baseball + pairwise(M2)
```

We may assess the difference that the new information makes:

```{r,label=baseballtransplot,cache=TRUE}
ordertransplot(baseball_maxp[1:7],maxp(baseball)[1:7],xlab="old",ylab="new",plotlims=c(0.01,0.16))
```

Above, we see very little difference in the two evaluates, except for
Detroit and Milwaukee, as expected.
    
### Some further thoughts on the home ground monster and Agresti's analysis.

Considering the simplest case of two teams, a and b, with results:

* $a$ at home, $b$ away, $a,b$ wins with probability $\frac{\lambda a,b}{\lambda a+b}$ (Agresti), or $\frac{a+H,b}{a+b+H}$ (me). 
* $a$ away, $b$ at home, $a,b$ wins with probability $\frac{a,\lambda b}{\lambda a+b}$ (Agresti), or $\frac{a,b+H}{a+b+H}$ (me).

Matching the probabilities for $a$ at home gives us $H=a(\lambda-1)$
and matching the probabilities for $a$ away gives $H=b(\lambda-1)$.
These cannot both be true unless $a=b$ or $\lambda=1$.  But we can, in
principle, test which one is a better model.


# hyper3 idiom

We may apply `hyper3` idiom to the dataset, using the likelihood
function of Davidson and Beaver (1977).  First a formal test:

```{r,label=optimizebaseball,cache=TRUE}
baseball_table
f <- function(l){ maxp(home_away3(baseball_table,l),give=TRUE,n=1)$likes}
o <- optimize(f,c(0.8,1.6),maximum=TRUE)
o
lambda_baseball <- o$maximum
maxL <- f(lambda_baseball)
W <- maxL - f(1)    # f(1) being the likelihood of the null
W
pchisq(2*W,df=1,lower.tail=FALSE)
```

The pvalue is significant.  Now plot a profile likelihood (support)
curve:

```{r, label=hyper3_baseball,cache=TRUE}
jj1  <- seq(from=log(lambda_baseball),to=log(1.9),len=7)
jj2  <- seq(from=log(lambda_baseball),to=log(0.8),len=7)
l <- sort(unique(exp(c(jj1,jj2))))
lam  <- sort(c(l,lambda_baseball))
L <- sapply(lam,f) - maxL
```

```{r,label=plothyper3baseball}
plot(log(lam),L,type="b")
abline(h=c(0,-2))
abline(v=0)

plot(lam,L,type="b")
abline(h=c(0,-2))
```

# Creating a home/away results table from scratch

Function `home_away_table()` takes a data frame of results and
produces a table amenable to analysis by `home_away()` or
`home_away3()`.


```{r showdata}
a <- read.table("celtic_rangers_livingston_falkirk.txt", header=TRUE)
head(a)
teams <- c("Rangers","Celtic","Falkirk","Livingston")
(aF <- home_away_table(a, give=FALSE,teams = teams))
(aT <- home_away_table(a, give=TRUE, teams = teams))
```

(from here on we ignore draws and consider only won games)

```{r doscottish,cache=TRUE}
(H <- home_away(aF))
pnames(H) <- c(teams,"home")
H
(mH <- maxp(H))
```

```{r testrangersandceltic, cache=TRUE}
samep.test(H,c("Rangers","Celtic"))


```{r  testhomezero, cache=TRUE}
specificp.gt.test(H,"home",0)
```

```{r dohome3, cache=TRUE}
home_away3(aF,lambda=1.88)
maxp(home_away3(aF,lambda=1.88),give=1)
maxp(home_away3(aF,lambda=1.11),give=1)
```


```{r calcsuppscotty,cache=TRUE}
f <- function(l){ maxp(home_away3(aF,l),give=TRUE,n=1)$likes}
lam <- seq(from=1.4,to=2.3,len=10)
date()
loglike <- sapply(lam,f)
date()
```

```{r optscotty,cache=TRUE}
(o <- optimize(f,c(1.1,4.6),maximum=TRUE))
```

```{r scottychisq,cache=TRUE}
o
scot_max_lambda <- o$maximum
maxL <- f(scot_max_lambda)

W <- maxL - f(1)    # f(1) being the likelihood of the null
W
pchisq(2*W,df=1,lower.tail=FALSE)
```

```{r scotmax}
(H <- home_away3(home_away_table(a,give=FALSE),scot_max_lambda))  # o$maximum ~= 1.353
maxp(H,give=1)
```

```{r}
plot(lam,loglike-max(loglike),type='b')
abline(h=c(0,-2))
abline(v=1)
grid()
```

```{r rememberhyper2}
(mH2 <- round(mH*1000))
```


```{r sfasdf, cache=TRUE}
o$maximum
mH3 <- maxp(home_away3(home_away_table(a,give=FALSE),scot_max_lambda),give=FALSE)
round(mH3*1000)
```

# Rangers vs Falkirk {-}


**(Rangers at home)**

* hyper2: P(Rangers;Falkirk) = $\frac{448+67; 56}{448 + 56 + 67}\simeq (0.902; 0.098)$
* hyper3: P(Rangers;Falkirk) = $\frac{1.77*448; 56}{1.77*448+56}\simeq(0.934; 0.066)$

actual scoreline: 69(R) / 2(F) or about $(0.972; 0.028)$. Expectation
would be (64;7) (H2) or (66.3;4.7) (H3)

*(Rangers away)*

* hyper2: P(Rangers;Falkirk) = $\frac{448; 56+67}{448 + 56 + 67}\simeq (0.78;0.22)$
* hyper3: P(Rangers;Falkirk) = $\frac{448; 1.77*56}{448 + 1.77*56}\simeq(0.82; 0.18)$ 

actual scoreline: 57(R) /17(F) - or about $(0.77; 0.23)$

# Rangers vs Livingston {-}


**(Rangers at home)**

* hyper2: P(Rangers;Livingston) = $\frac{448+67; 39}{448 + 39 + 67}\simeq (0.930; 0.070)$
* hyper3: P(Rangers;Livingston) = $\frac{1.77*448; 39}{1.77*448+39}\simeq(0.953; 0.047)$

actual scoreline:  15(R) / 0(L) or  $(1; 0)$

*(Rangers away)*

* hyper2: P(Rangers;Livingston) = $\frac{448; 39+67}{448 + 39 + 67}\simeq (0.81;0.19)$
* hyper3: P(Rangers;Livingston) = $\frac{448; 1.77*39}{448 + 1.77*39}\simeq(0.86; 0.14)$ 

actual scoreline: 12(R) /2(L) - or about $(0.86; 0.14)$


# Celtic vs Falkirk {-}


*(Celtic at home)*

* hyper2: P(Celtic;Falkirk) = $\frac{390+67; 56}{390 + 56 + 67}\simeq (0.89; 0.11)$
* hyper3: P(Celtic;Falkirk) = $\frac{1.77*412; 74}{1.77*412+74}\simeq(0.92; 0.08)$

actual scoreline:  61-8 or about $(0.88; 0.12)$

*(Celtic away)*

* hyper2: P(Celtic;Falkirk) = $\frac{390; 56+67}{390 + 56 + 67}\simeq (0.76;0.24)$
* hyper3: P(Celtic;Falkirk) = $\frac{412; 1.77*74}{412 + 1.77*74}\simeq(0.76; 0.24)$ 

actual scoreline: 43-17 or about $(0.72; 0.28)$



# Livingston vs Falkirk {-}


*(Livingston at home)*

* hyper2: P(Livingston;Falkirk) = $\frac{39+67; 56}{39 + 67 + 56}\simeq (0.65; 0.35)$
* hyper3: P(Livingston;Falkirk) = $\frac{1.77*42; 74}{1.77*42+74}\simeq(0.50; 0.50)$

actual scoreline: 3-9 or about $(0.25; 0.75)$

*(Livingston away)*

* hyper2: P(Livingston;Falkirk) = $\frac{39; 56+67}{39 + 56 + 67}\simeq (0.24;0.76)$
* hyper3: P(Livingston;Falkirk) = $\frac{42; 1.77*74}{42 + 1.77*74}\simeq(0.24; 0.76)$ 

actual scoreline: 6-8 or about $(0.43; 0.57)$



# Expectations


First, hyper2:

```{r}
mH
mH["Rangers"]
mH["home"]
mH3
lambda <- scot_max_lambda
h2_exp <- matrix(0,4,4)
rownames(h2_exp) <- teams
colnames(h2_exp) <- teams
h3_exp <- h2_exp
n_matches <- Re(aF) + Im(aF)
for(hometeam in teams){
    for(awayteam in teams){

        h2_exp[hometeam,awayteam] <- (
            n_matches[hometeam,awayteam] * (mH[hometeam] + mH["home"])/
            (mH[hometeam] + mH[awayteam] + mH["home"])
        )
        h2_exp[hometeam,awayteam] %<>%
            add(1i*
                n_matches[hometeam,awayteam] * (mH[awayteam])/
                (mH[hometeam] + mH[awayteam] + mH["home"])
                )
        
        h3_exp[hometeam,awayteam] <- (
            n_matches[hometeam,awayteam] * (lambda* mH3[hometeam])/
            (lambda* mH3[hometeam] + mH3[awayteam])
        )

        h3_exp[hometeam,awayteam] %<>%
            add(1i*
                n_matches[hometeam,awayteam] * (mH3[awayteam])/
                (lambda* mH3[hometeam] + mH3[awayteam])
        )
    }
}
aF
round(h2_exp,1)
round(h3_exp,1)

makev <- function(M){
    out <- c(Re(M),Im(M))
    out[!is.na(out)]
}
    

(obs <- makev(aF))
(exp2 <- makev(h2_exp))
(exp3 <- makev(h3_exp))

plot((obs-exp2)^2/exp2)
plot((obs-exp3)^2/exp3)


chisq2 <- sum((obs-exp2)^2/exp2)
chisq3 <- sum((obs-exp3)^2/exp3)

pchisq(chisq2,df=12-4,lower.tail=FALSE)
pchisq(chisq3,df=12-4,lower.tail=FALSE)

par(pty='s')
plot(obs,exp2,log="xy",asp=1,xlim=c(1,100),ylim=c(1,100))
abline(0,1)
plot(obs,exp3,log="xy",asp=1,xlim=c(1,100),ylim=c(1,100))
abline(0,1)
```


```{r defineexpectation2}
expectation2 <- function(probs, results){
    teams <- names(probs[names(probs) != "home"])
    h2_exp <- matrix(0,4,4)
    rownames(h2_exp) <- teams
    colnames(h2_exp) <- teams
    n_matches <- Re(aF) + Im(aF)
    for(hometeam in teams){
        for(awayteam in teams){
            
            h2_exp[hometeam,awayteam] <- (
                n_matches[hometeam,awayteam] * (mH[hometeam] + mH["home"])/
                (mH[hometeam] + mH[awayteam] + mH["home"])
            )
            
            h2_exp[hometeam,awayteam] %<>%
                add(1i*
                    n_matches[hometeam,awayteam] * (mH[awayteam])/
                    (mH[hometeam] + mH[awayteam] + mH["home"])
                    )
        }
    }
    return(h2_exp)
}
round(expectation2(mH,aF),1)
```


```{r defineexp3}

expectation3 <- function(probs, results, lambda){
    teams <- names(probs)
    h3_exp <- matrix(0,4,4)
    rownames(h3_exp) <- teams
    colnames(h3_exp) <- teams
    n_matches <- Re(aF) + Im(aF)
    for(hometeam in teams){
        for(awayteam in teams){
            
            h3_exp[hometeam,awayteam] <- (
                n_matches[hometeam,awayteam] * (lambda* mH3[hometeam])/
                (lambda* mH3[hometeam] + mH3[awayteam])
            )
            
            h3_exp[hometeam,awayteam] %<>%
                add(1i*
                    n_matches[hometeam,awayteam] * (mH3[awayteam])/
                    (lambda* mH3[hometeam] + mH3[awayteam])
                    )
        }
    }
    return(h3_exp)
}

round(expectation3(mH3[c("Rangers","Celtic","Falkirk","Livingston")],aF,scot_max_lambda),1)
```

###  References

* R. R. Davidson and R. J. Beaver 1977. "On extending the
  Bradley-Terry model to incorporate within-pair order effects"
  _Biometrics_, 33:693--702


### Package dataset {-}

Following lines create `baseball.rda`, residing in the `data/`
directory of the package.

```{r,label=savesolingdataset}
save(baseball_table, baseball, baseball_maxp, 
  file="baseball.rda")
```

