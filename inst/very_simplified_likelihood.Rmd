---
title: "Very simplified likelihood"
author: "Robin Hankin"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("hyper2")
library("pracma")
```

```{r hexsticker, out.width='20%', out.extra='style="float:right; padding:10px"',echo=FALSE}
knitr::include_graphics(system.file("help/figures/hyper2.png", package = "hyper2"))
```

Consider a race between a competitor of Bradley-Terry strength $a$ and
$n$ competitors each of strength $b$; we require $a+b=1$.  An
observation is indexed by $r$, the number of $b$ clones finishing
ahead of $a$, so $0\leqslant r\leqslant n$.  The initial field
strength is $a+nb=n+(n-1)a$.


Probability of the focal competitor coming first:

\[
\frac{a}{a+nb}=\frac{a}{n - a(n-1)a}=\frac{1-b}{1+(n-1)b}
\]

Coming second:
\[
\frac{b}{a+nb}\cdot\frac{a}{a+(n-1)b}
\]


Third:

\[
\frac{b}{a+nb}\cdot\frac{b}{a+(n-1)b}\cdot\frac{a}{a+(n-2)b}
\]




### Likelihood functions


Suppose our bro comes first (zero $b$'s ahead of him):

\[\mathcal{L}(a)=\frac{a}{a+nb}=\frac{a}{n+(n-1)a}\]

Comes second, one $b$ ahead of him:

\[
\mathcal{L}(a)=\frac{b}{a+nb}\cdot\frac{a}{a+(n-1)b}
\]


Third, two ahead of him:

\[
\mathcal{L}(a)=
\frac{b}{a+ n   b}\cdot
\frac{b}{a+(n-1)b}\cdot
\frac{a}{a+(n-2)b}
\]


Fourth, three ahead:

\[
\mathcal{L}(a)=
\frac{b}{a+ n   b}\cdot
\frac{b}{a+(n-1)b}\cdot
\frac{b}{a+(n-2)b}\cdot
\frac{a}{a+(n-3)b}
\]

Placing after $r<n$ of the $n$ clones of strength $b$ finish:

\[
\mathcal{L}(a)=
\frac{b^ra}{
(a+nb)(a+(n-1)b)(a+(n-2)b)\cdots(a+(n-r)b)}
=
\frac{B-1}{(B+n-1)(B+n-2)\cdots(B+n-r-1)}
\]

where $B=1/b$.

## Placing last

Placing last is finishing  after $n$ clones finish:

\[
n=1\longrightarrow\mathcal{L}=b\]

\[
n=2\longrightarrow\mathcal{L}=\frac{b}{a+2b}\cdot\frac{b}{a+b}=\frac{b^2}{1+b}
\]

\[
n=3\longrightarrow\mathcal{L}=\frac{b}{a+3b}\cdot\frac{b}{a+2b}\cdot\frac{b}{a+b}=\frac{b^3}{(1+b)(1+2b)}
\]


\[
n=4\longrightarrow\mathcal{L}=\frac{b}{a+4b}\cdot\frac{b}{a+3b}\cdot\frac{b}{a+2b}\cdot\frac{b}{a+b}=
\frac{b^4}{(1+b)(1+2b)(1+3b)}
\]

For $n=4$ we have equivalently

\[
\frac{1}{B(B+1)(B+2)(B+3)}=\frac{(B-1)!}{(B+3)!}=\frac{\Gamma(B)}{\Gamma(B+4)}
\]

\[
\frac{B-1}{(B+n-1)(B+n-2)\cdots(B+1)\cdot B\cdot(B-1)}
\]

(denominator has $n+1$ terms).  In R:


```{r}
f_single <- function(a,r,n,log=FALSE){  # not vectorised
  B <- 1/(1-a)
  if(log){
     if(r==n){
       out <- lgamma(B)-lgamma(B+n)
     } else {
       out <- log(B-1) - sum(log(B + B+(n-r-1):(n-1)))
     }
   } else {  # not-log 
     if(r==n){
      out <- gamma(B)/gamma(B+n)
     } else {
       out <- (B-1)/prod(B+(n-r-1):(n-1))
     }
   }	
   return(out)
}x


f_vec_a <- function(a,r,n, log=FALSE){  # vectorised in 'a' but not in 'r'
 sapply(a,function(a){f_single(a,r=r,n=n,log=log)})
}

f <- function(a,r,n,log=FALSE){ # vectorized in 'a', treats 'r' as a vector of independent observations

  if(log){
    out <- 0
    for(rr in r){out <- out + f_vec_a(a,rr,n,log=TRUE)}
  } else {
    out <- 1
    for(rr in r){out <- out * f_vec_a(a,rr,n,log=FALSE)}
  }
  return(out)
}

MLE <- function(r,n){
    d <- 1e-6
   optimize(f,c(d,1-d),r=r,n=n,log=TRUE,maximum=TRUE)
}
MLE(3,9)
```


Now verification

```{r}
a <- 0.23423434
b <- 1-a
B <- 1/b
n <- 9
r <- 3
c(
b^3*a/((a+9*b) * (a+8*b) * (a+7*b) * (a+6*b)),
(B-1)/prod(B+(5:8)),
f(a,r,n,log=FALSE))
```

Now some visuals.  Suppose $r=4,n=8$:

```{r}
a <- seq(from=0,to=1,by=0.01)
plot(a,f(a,3,8,log=FALSE))
```

# Formula 1.

```{r maxvscheco}
a <- read.table("formula1_2023.txt",header=TRUE)
a <- a[,seq_len(ncol(a)-1)]
d1 <- as.numeric(as.matrix(a)["Ocon",])
d2 <- as.numeric(as.matrix(a)["Gasly",])
d1[is.na(d1)] <- 22
d2[is.na(d2)] <- 22
d1
d2
MLE(d1,22)
MLE(d2,22)
```

two sample test:

```{r 2samptest}
both <- c(d1,d2)
bothmax <- MLE(both,22)$maximum

d1max <- MLE(d1,22)$maximum
d2max <- MLE(d2,22)$maximum
f(bothmax,d1,22,log=TRUE)
f(bothmax,d2,22,log=TRUE)
f(d1max,d1,22,log=TRUE)
f(d2max,d2,22,log=TRUE)

Lambda <- (f(d2max,d1,22,log=TRUE)+f(d2max,d2,22,log=TRUE)) -(f(bothmax,d1,22,log=TRUE)+f(bothmax,d2,22,log=TRUE))
Lambda
pchisq(-2*Lambda,df=1,lower.tail=FALSE)
```


## Mathematical Olympiad


```{r readoly}
sametest <- function(d1,d2,n){
  both <- c(d1,d2)
  bothmax <- MLE(both,n)$maximum

  d1max <- MLE(d1,n)$maximum
  d2max <- MLE(d2,n)$maximum
  Lambda <- (f(d2max,d1,n,log=TRUE)+f(d2max,d2,n,log=TRUE)) -(f(bothmax,d1,n,log=TRUE)+f(bothmax,d2,n,log=TRUE))
  pchisq(-2*Lambda,df=1,lower.tail=FALSE)
}

a <- as.matrix(read.table("olympiad.txt"))
nrow(a)
d1 <- a["AUS",]
d2 <- a["NZL",]
d1
d2
sametest(d1,d2,100)
a["USA",]
a["CHN",]
sametest(a["USA",],a["CHN",],100)
sametest(a["USA",],a["CHN",],5)
```

