
---
title: "Very simplified likelihood"
author: "Robin Hankin"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("hyper2")
library("pracma")
```

```{r hexsticker, out.width='20%', out.extra='style="float:right; padding:10px"',echo=FALSE}
knitr::include_graphics(system.file("help/figures/hyper2.png", package = "hyper2"))
```

Consider a race between a competitor of Bradley-Terry strength $a$ and
$n$ competitors each of strength $b$; we require $a+b=1$.  NB we have
$n+1$ competitors in total, 1 of strength $a$ and $n$ of strength $b$.
An observation is indexed by $r$, the number of $b$ clones finishing
ahead of $a$, so $0\leqslant r\leqslant n$.  The initial field
strength is $a+nb=n+(n-1)a$.


Suppose our bro comes first (zero $b$'s ahead of him):

\[
\mathcal{L}(a)=\frac{a}{a+nb}=\frac{1-b}{1+(n-1)b}
\]

Comes second, one $b$ ahead of him:

\[
\mathcal{L}(a)=\frac{b}{a+nb}\cdot\frac{a}{a+(n-1)b}
\]


Third, two ahead of him:

\[
\mathcal{L}(a)=
\frac{b}{a+ n   b}\cdot
\frac{b}{a+(n-1)b}\cdot
\frac{a}{a+(n-2)b}
\]


Fourth, three ahead:

\[
\mathcal{L}(a)=
\frac{b}{a+ n   b}\cdot
\frac{b}{a+(n-1)b}\cdot
\frac{b}{a+(n-2)b}\cdot
\frac{a}{a+(n-3)b}
\]

Placing after $r<n$ of the $n$ clones of strength $b$ finish:

\[
\mathcal{L}(a)=
\frac{b^ra}{
(a+nb)(a+(n-1)b)(a+(n-2)b)\cdots(a+(n-r)b)}
=
\frac{B-1}{(B+n-1)(B+n-2)\cdots(B+n-r-1)}
\]

where $B=1/b$ [also using the fact that $a+b=1$].

## Placing last

Placing last is finishing  after $n=r$ clones finish:

\[
n=1\longrightarrow\mathcal{L}=b\]

\[
n=2\longrightarrow\mathcal{L}=\frac{b}{a+2b}\cdot\frac{b}{a+b}=\frac{b^2}{1+b}
=\frac{1}{B(B+1)}
\]

\[
n=3\longrightarrow\mathcal{L}=\frac{b}{a+3b}\cdot\frac{b}{a+2b}\cdot\frac{b}{a+b}=\frac{b^3}{(1+2b)(1+b)}=\frac{1}{B(B+1)(B+2)}
\]


\[
n=4\longrightarrow\mathcal{L}=\frac{b}{a+4b}\cdot\frac{b}{a+3b}\cdot\frac{b}{a+2b}\cdot\frac{b}{a+b}=
\frac{b^4}{(1+3b)(1+2b)(1+b)}=
\frac{1}{B(B+1)(B+2)(B+3)}
\]

For $n=4$ we have equivalently

\[
\frac{1}{(B+3)(B+2)(B+1)B}=\frac{(B-1)!}{(B+3)!}=\frac{\Gamma(B)}{\Gamma(B+4)}
\]

In general we would have

\[
\frac{1}{(B+n-1)(B+n-2)\cdots(B+1)B}=\frac{(B-1)!}{(B+n)!}=\frac{\Gamma(B)}{\Gamma(B+n+1)}
\]



(denominator has $n+1$ terms).  In R:


```{r}
f_single <- function(a,r,n,log=FALSE){  # not vectorised
  B <- 1/(1-a)
  if(log){
     if(r==n){  # last place
       out <- lgamma(B)-lgamma(B+n)
     } else {   # not last
       out <- log(B-1) - sum(log(B + B+(n-r-1):(n-1)))
     }
   } else {  # not-log 
     if(r==n){
      out <- gamma(B)/gamma(B+n)
     } else {
       out <- (B-1)/prod(B+(n-r-1):(n-1))
     }
   }	
   return(out)
}


f_vec_a <- function(a,r,n, log=FALSE){  # vectorised in 'a' but not in 'r'
 sapply(a,function(a){f_single(a,r=r,n=n,log=log)})
}

f_vec_arn <- function(a,r,n,log=FALSE){ ## vectorized in 'a'; treats 'r' and 'n' as
                                ## vectors of independent observations 

  M <- cbind(r,n)

  if(log){
    out <- 0
    for(i in seq_len(nrow(M))){out <- out + f_vec_a(a,r=M[i,1],n=M[i,2],log=TRUE)}
  } else {
    out <- 1
    for(i in seq_len(nrow(M))){out <- out * f_vec_a(a,r=M[i,1],n=M[i,2],log=FALSE)}
  }
  return(out)
}

MLE <- function(r,n){
    d <- 1e-6
    optimize(f_vec_arn,c(d,1-d),r=r,n=n,log=TRUE,maximum=TRUE)
}
MLE(0,9)
MLE(3,9)
MLE(3,7)
```

Now verification

```{r}
a <- 0.23423434
b <- 1-a
B <- 1/b
n <- 9
r <- 3
c(
b^3*a/((a+9*b) * (a+8*b) * (a+7*b) * (a+6*b)),
(B-1)/prod(B+(5:8)),
f_vec_arn(a,r,n,log=FALSE))
```


```{r}
out <- list()
for(n in 1:10){
  out[[n]]  <- rep(NA,n+1)
  for(r in 0:n){
    if(r==0){
      jj <- 1
    } else if(r==n){n
      jj <- 0
    } else {
      jj <- MLE(r,n)$maximum
    }  
    out[[n]][r+1] <- jj
  }
} 
out
```

```{r}
plotterp <- function(...){
plot(NA,xlim=c(1,10),ylim=c(0,1),type="n",xlab="n",ylab=expression(hat(a)))
for(n in 1:10){
  for(r in 0:n){   points(n,out[[n]][r+1],pch=16) }
  for(r in 0:n){   text(n+0.2,out[[n]][r+1],r,cex=0.5,col='gray') }
}
}
plotterp()
pdf(file="dotprobs.pdf")
plotterp()
dev.off()
```


## Note on the differences between probability and likelihood

The likelihood calculations above can be confusing becuase likelihood
is not the same as probability.

Consider, for example, $n=2$ so we have 3 competitors.

probability of focal competitor coming first [i.e. $r=0$]:

\[\frac{a}{a+2b}=\frac{1-b}{1+b}\]

Now what is the probability of coming second, that is, $r=1$?

My first thought was:

\[
\mbox{prob of coming second}   =
\frac{b}{a+2b}\cdot\frac{a}{a+b}=\frac{b(1-b)}{1+b}\qquad\mbox{WRONG}
\]

but this is incorrect: there are two clones of (strength) $b$, and the
likelihood arguments above do not distinguish between their finishing
order.  We can name the competitors $a$, $b_1$ and $b_2$ and specify
that $b_1$ and $b_2$ both have strength $b$.  Then "coming second"
means that the finishing order was $b_1,a,b_2$ or $b_2,a,b_1$.  Noting
that these events are disjoint, the probability would be

\[\mbox{prob of coming second}   =
\operatorname{P}(b_1,a,b_2)      +
\operatorname{P}(b_2,a,b_1)      =
\frac{b}{a+2b}\cdot\frac{a}{a+b} +
\frac{b}{a+2b}\cdot\frac{a}{a+b} = \frac{2(1-b)}{1+b}
\]

Similarly for the focal competitor coming last we need to sum the
probabilities of finishing orders $b_1,b_2,a$ and $b_2,b_1,a$:

\[\mbox{prob of coming third}=
\operatorname{P}(b_1,b_2,a) +
\operatorname{P}(b_2,b_1,a) =
\frac{b}{a+2b}\cdot\frac{b}{a+b}+
\frac{b}{a+2b}\cdot\frac{b}{a+b}=
\frac{2b^2}{1+b}.
\]

Above we see a factor of two difference between the probabilities and
the likelihoods presented previously.  Note that there is no such
factor for the probability of the focal competitor finishing first:

\[
\mbox{prob of coming first}      =
\operatorname{P}(a,b_1,b_2)      +
\operatorname{P}(a,b_2,b_1)      =
\frac{b}{a+2b}\cdot\frac{b}{b+b} +
\frac{b}{a+2b}\cdot\frac{b}{b+b} = \frac{1-b}{1+b}
\]


Now we see that the probabilities sum to

\[
\frac{1-b}{1+b} + \frac{2b^2}{1+b} + \frac{2(1-b)}{1+b}=1
\]


Now try $r=3$ [i.e. 4 competitors].  Taking things one step at a time:

\[
\mbox{prob of coming first} =
3!\cdot\frac{a}{a+3b}\cdot\frac{b}{3b}\cdot\frac{b}{2b}\cdot\frac{b}{b}=
\frac{1-b}{1+2b}
\]

\[
\mbox{prob of coming second} =
3!\cdot\frac{b}{a+3b}\cdot\frac{a}{a+2b}\cdot\frac{b}{2b}\cdot\frac{b}{b}=
3\cdot\frac{b(1-b)}{(1+2b)(1+b)}
\]

\[
\mbox{prob of coming third} =
3!\cdot\frac{b}{a+3b}\cdot\frac{b}{a+2b}\cdot\frac{a}{a+b}\cdot\frac{b}{b}
=
6\cdot\frac{b^2(1-b)}{(1+2b)(1+b)}
\]
\[
\mbox{prob of coming fourth (last)} =
3!\cdot\frac{b}{a+3b}\cdot\frac{b}{a+2b}\cdot\frac{b}{a+b}\cdot\frac{a}{a}
=
6\cdot\frac{b^3}{(1+2b)(1+b)}
\]

The sum would be $[(1+b)(1-b) + 3b(1-b) + 6b^2(1-b) +
6b^3]/[(1+b)(1+2b)]=1$.

Now consider the general case.  Again, $n$ clones of strength $b$ and
one of strength $a=1-b$, $n+1$ competitors.

\[
\mbox{prob of coming first} =
n!\cdot\frac{b}{a+nb}\cdot\frac{b}{nb}\cdot\frac{b}{(n-1)b}\cdots\frac{b}{b}
=
\frac{b}{1+(n-1)b}
\]

\[
\mbox{prob of coming second} =
n!\cdot\frac{b}{a+nb}\cdot\frac{a}{a+(n-1)b}\cdot\frac{b}{(n-1)b}\cdot\frac{b}{(n-2)b}\cdots\frac{b}{2b}\cdot\frac{b}{b}
=n\cdot X
\]



## Visuals


Now some likelihood visuals.  Suppose $r=4,n=8$:

```{r,label=likevis,cache=TRUE}
plotter <- function(...){
a <- seq(from=0,to=1,by=0.01)
n <- 7
jj <- f(a,3,n,log=FALSE)
plot(a,jj/max(jj,na.rm=TRUE),type='n')
grid()
for(r in seq(from=0,to=n)){
  y <- f_vec_a(a,r,n,log=FALSE)
  if(r==0){y[length(y)] <- 1}  
  y <- y/max(y,na.rm=TRUE)
  if(r>0){y[length(y)] <- 0}
  points(a,y,type='l',lwd=4,col=rainbow(n+1)[r+1])
  segments(x0=r/(n),y0=0.9,y1=1)
  text(x=r/(n),y=0.8,r)
}
}
plotter()
pdf(file="ninelikes.pdf")
plotter()
dev.off()
```

# Formula 1.

```{r maxvscheco}
a <- read.table("formula1_2023.txt",header=TRUE)
a <- a[,seq_len(ncol(a)-1)]
d_ocon  <- as.numeric(as.matrix(a)["Ocon",])
d_gasly <- as.numeric(as.matrix(a)["Gasly",])
d_ocon [is.na(d_ocon )] <- 22
d_gasly[is.na(d_gasly)] <- 22
d_ocon
d_gasly
MLE(d_ocon ,22)
MLE(d_gasly,22)
```

two sample test:

```{r 2samptest}
both <- c(d_ocon,d_gasly)
bothmax <- MLE(both,22)$maximum

d_ocon_max  <- MLE(d_ocon ,22)$maximum
d_gasly_max <- MLE(d_gasly,22)$maximum
f_vec_arn(bothmax,d_ocon ,22,log=TRUE)
f_vec_arn(bothmax,d_gasly,22,log=TRUE)
f_vec_arn(d_ocon_max ,d_ocon ,22,log=TRUE)
f_vec_arn(d_gasly_max,d_gasly,22,log=TRUE)

Lambda <- (
   (f_vec_arn(d_gasly_max  ,d_ocon,22,log=TRUE)+f_vec_arn(d_gasly_max  ,d_gasly,22,log=TRUE)) -
   (f_vec_arn(bothmax      ,d_ocon,22,log=TRUE)+f_vec_arn(bothmax      ,d_gasly,22,log=TRUE))
)
Lambda
pchisq(-2*Lambda,df=1,lower.tail=FALSE)
```


## Mathematical Olympiad


```{r readoly}
sametest <- function(d1,d2,n){
  both <- c(d1,d2)
  bothmax <- MLE(both,n)$maximum

  d1max <- MLE(d1,n)$maximum
  d2max <- MLE(d2,n)$maximum
  Lambda <- (
  (f_vec_arn(d2max  ,d1,n,log=TRUE)+f_vec_arn(d2max  ,d2,n,log=TRUE)) -
  (f_vec_arn(bothmax,d1,n,log=TRUE)+f_vec_arn(bothmax,d2,n,log=TRUE))
)
  pchisq(-2*Lambda,df=1,lower.tail=FALSE)
}

a <- as.matrix(read.table("olympiad.txt"))
nrow(a)
d1 <- a["AUS",]
d2 <- a["NZL",]
d1
d2
sametest(d1,d2,100)
a["USA",]
a["CHN",]
sametest(a["USA",],a["CHN",],100)
sametest(a["USA",],a["CHN",],5)
```

## Parkrun

```{r readresults}
results <- read.table("parkrun_results.txt",header=TRUE)
results
```

Above we see three parkrun results.  In parkrun number 148, I placed
229 out of a field of 318.


```{r definelikelihood}

L <- function(a,results){
   out <- a*0
   for(i in seq_len(nrow(results))){
   jj <- f_vec_a(a,r=results$place[i]-1,results$runners[i]-1,log=TRUE)
   out <- out + jj
   }
   out[is.infinite(out)] <- NA
   return(out)
}
```

```{r calculatelikes,cache=TRUE}
a <- seq(from=0.15,to=0.5,by=0.01)
La <- L(a,results)
La <- La-max(La,na.rm=TRUE)
La2 <- f_vec_arn(a,r=results$place-1,results$runners-1,log=TRUE)
La2 <- La2 - max(La2,na.rm=TRUE)
```

```{r plotlike}
plot(a,La)
points(a,La2)
abline(h=c(0,-2))
```

```{r optimsinglelike}
optimize(function(a){L(a,results)},c(0.3,0.4),maximum=TRUE)
```


```{r splitresults}
supp2 <- function(vec,place,runners){
  a_stirling <- vec[1]
  a_auckland <- vec[2]
  out <- 0
  for(i in 1:3){
    out <- out + f_vec_a(a_stirling,r=place[i]-1,runners[i]-1,log=TRUE)
  }
  for(i in 4:10){
    out <- out + f_vec_a(a_auckland,r=place[i]-1,runners[i]-1,log=TRUE)
  }
  return(out)
}
```


```{r,label=calcbothlikes,cache=FALSE}
x <- seq(from=0.1,to=0.8,by=0.01)
jj <- as.matrix(expand.grid(x,x))
L <- apply(jj,1,supp2,results$place,results$runners)
L <- L - max(L,na.rm=TRUE)
L <- matrix(L,length(x),length(x))
```

```{r,label=plotbothlikes}
par(pty='s')
contour(x,x,L,asp=1,xlim=range(x),ylim=range(x),levels=-(0:5))
abline(0,1)
```


```{r, label=onedimopt}
f <- function(a){supp2(c(a,a),results$place,results$runners)}
a <- seq(from=0.1,to=0.6,by=0.05)
alike <- sapply(a,f)
plot(a,alike,type='b')
optimize(f,c(0.1,0.6),maximum=TRUE)
```

```{r, label=twodimopt}
f2 <- function(v){supp2(v,results$place,results$runners)}
optim(par=c(0.6,0.3),f2,control=list(fnscale=-1))
```

```{r,label=showchisquareasymptotic}
pchisq(2*(7381.496-7380.314),df=1,lower.tail=FALSE)
```



## Education

The focal competitor

```{r}
rank <- c( 9, 7, 2, 3,2 ,8 ,5 ,4 ,9 )
class_size <- c(12, 17,23, 9,13,14,13,12,15)
course <- c("rings and modules","group theory","calculus","linear algebra",
"differential equations","topology","special relativity","fluid mechanics","Lie algebra")
category=c("pure","pure","applied","applied","applied","pure","applied","applied","pure")
data.frame(course,category,rank,class_size)
```


```{r}
a <- seq(from=0.1,by=0.01,to=0.7)
wp <- category=='pure'
wa <- category=='applied'
```

Pure first

```{r}
Lpure <- f_vec_arn(a,rank[wp]-1,class_size[wp]-1,log=TRUE)
Lpure <- Lpure - max(Lpure,na.rm=TRUE)
plot(a,Lpure)
optimize(function(a){f_vec_arn(a,rank[wp]-1,class_size[wp]-1,log=TRUE)},c(0.3,0.6),maximum=TRUE)
optimize(function(a){f_vec_arn(a,rank[wa]-1,class_size[wa]-1,log=TRUE)},c(0.3,0.6),maximum=TRUE)
```


```{r}
supp2_ed <- function(vec,place1,place2,runners1,runners2){
  out <- 0
  M1 <- cbind(place1,runners1)
  M2 <- cbind(place2,runners2)
  for(i in seq_len(nrow(M1))){
    out <- out + f_vec_arn(vec[1],r=M1[i,1]-1,n=M1[i,2]-1,log=TRUE)
  }
  for(i in seq_len(nrow(M2))){
    out <- out + f_vec_arn(vec[2],r=M2[i,1]-1,n=M2[i,2]-1,log=TRUE)
  }
  return(out)
}
```

```{r,cache=TRUE}
x <- seq(from=0.1,to=0.95,by=0.01)
jj <- as.matrix(expand.grid(x,x))
L <- apply(jj,1,supp2_ed,rank[wp]-1,rank[wa]-1,class_size[wp]-1,class_size[wa]-1)
L <- L - max(L,na.rm=TRUE)
L <- matrix(L,length(x),length(x))
```

```{r}
par(pty='s')
contour(x,x,L,asp=1,xlim=range(x),ylim=range(x),levels=-(0:5),
xlab='pure strength',ylab='applied strength')
abline(0,1)
```

```{r}
jj1 <- 
optim(
   c(.4,.8),
   function(vec){
      supp2_ed(vec,rank[wp]-1,rank[wa]-1,class_size[wp]-1,class_size[wa]-1)},
   control=list(fnscale = -1)
)
jj1
```

```{r}
jj2 <-
optimize(function(v){supp2_ed(c(v,v),rank[wp]-1,rank[wa]-1,class_size[wp]-1,class_size[wa]-1)},
c(0.1,0.9),maximum=TRUE)
jj2
```

```{r}
pchisq(2*(jj1$value-jj2$objective),lower.tail=FALSE,df=1)
```

